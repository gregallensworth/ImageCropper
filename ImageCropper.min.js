jQuery.fn.ImageCropper=function(e){function t(){var e=parseInt(l.width)*s,t=parseInt(l.height)*s,i=(r.width()-e)/2,n=(r.height()-t)/2;r.css({"background-image":"url("+l.src+")","background-size":e+"px "+t+"px","background-position":i+"px "+n+"px","background-repeat":"no-repeat"})}function i(){s*=1.25,t()}function n(){s*=.8,t()}function a(){var t=e.width,i=e.height,n=r.css("background-position").split(" "),a=r.css("background-size").split(" "),u=parseInt(n[0])-r.width()/2+t/2,s=parseInt(n[1])-r.height()/2+i/2,c=parseInt(a[0]),h=parseInt(a[1]),g=parseInt(l.height),m=parseInt(l.width),f=document.createElement("canvas");f.width=t,f.height=i;var v=f.getContext("2d");v.drawImage(l,0,0,m,g,u,s,c,h);var b=f.toDataURL("image/jpeg");o.prop("src",b).show(),p.val(b.replace("data:image/jpeg;base64,","")),d.hide(),e.clearFileInput&&$fileinput.val(""),setTimeout(function(){e.onImageCropped(l,p,$fileinput)},1)}e=$.extend({width:1024,height:768,thumbWidth:256,thumbHeight:192,fieldName:$(this).prop("name"),clearFileInput:!0,onImageLoaded:function(){},onImageCropped:function(){}},e),$fileinput=$(this);var o=$('<img src="about:blank" />').hide().addClass("imageCropperThumbnail").width(e.thumbWidth).height(e.thumbHeight).appendTo($fileinput.parent()),p=$('<input type="hidden" />').prop("name",e.fieldName).val("").appendTo($fileinput.parent()),d=$("<div></div>").addClass("imageCropperWrapper").appendTo($fileinput.parent()).width(e.width).hide(),r=$("<div></div>").addClass("imageCropperCanvas").appendTo(d).width(e.width).height(e.height),u=$("<div></div>").addClass("imageCropperButtons").appendTo(d),s=($('<input type="button" value="+" />').appendTo(u).click(i),$('<input type="button" value="Crop & Save" />').appendTo(u).click(a),$('<input type="button" value="-" />').appendTo(u).click(n),1),l=new Image;l.onload=function(){d.show(),o.hide(),s=1,t(),setTimeout(function(){e.onImageLoaded(l,r,$fileinput)},1)},$fileinput.val("").change(function(){var e=new FileReader;e.onload=function(e){l.src=e.target.result},e.readAsDataURL(this.files[0])});var c,h,g;r.bind("mousedown",function(e){e.stopImmediatePropagation(),g=!0,c=e.clientX,h=e.clientY}).bind("mousemove",function(e){if(e.stopImmediatePropagation(),g){var t=e.clientX-c,i=e.clientY-h,n=r.css("background-position").split(" "),a=t+parseInt(n[0]),o=i+parseInt(n[1]);r.css("background-position",a+"px "+o+"px"),c=e.clientX,h=e.clientY}}).bind("mouseout",function(e){g=!1}).bind("mouseup",function(e){g=!1}).bind("mousewheel DOMMouseScroll",function(e){e.originalEvent.wheelDelta>0||e.originalEvent.detail<0?i():n()})};